# 命令行工具中loading动画的实现原理

## 概述
> &nbsp; 接触命令行工具后，经常使用它安装包文件，以及下载一些东西，下载时，总是有一个loading动画，一直很好奇这个动画是怎么实现的；由于对操作系统不是很了解，对于实现方式就猜测不到，而且这个东西在工作中也不是很重要，就没有深究，但这个好奇一直埋藏在心里。<br>
&nbsp; 今天突然想起这个事来，搜索了一下，看到有人分享实现原理，感觉很有意思，记录下来，算是对自己好奇心的一个报偿。


## 原理

CLI spinner 的原理很简单，你需要的是:

* 一组特殊字符，当它们连贯地动起来的时候能看起来像上面这些动画。
* 一个定时器，每一个字符看做一帧，定时按顺序切换每帧就能实现「动画效果」。

似乎还有些纰漏，不过可以先试试再找问题：

![](https://i.loli.net/2019/11/13/pWYF2qdIeNJZKrH.png)


显而易见，我们应该在同样的位置输出字符，而不是 console.log 这样每次输出都会换行。

我们知道用 \r 可以让终端把光标移到行首，这样再配合 process.stdout.write 输出内容的时候就会是相同的位置了。

![](https://i.loli.net/2019/11/13/msUdpixOHXfYL2J.png)

最后还有个 edge case 就是，当你的字符只有一个还好说，每次输出新的内容都能覆盖掉，但是如果新的字符串长度大于旧的字符串就会出现这种情况：

![](https://i.loli.net/2019/11/13/QlRTSIj5kqiX8mV.png)

终端只会覆盖有新字符的位置，因此过长的部分就永远不会变了。这个时候你需要在输出内容之前清除整行的内容：

```
process.stdout.clearLine()
```

这样一个能用的 spinner 就诞生了，多亏前人的实践，现在有了很多有趣的可以用作[spinner 的字符](https://github.com/sindresorhus/cli-spinners/blob/master/spinners.json)，你可以试试不同的效果。

## 模块推荐
把这个例子封装一个就成了 io-spin，它额外的功能就是 .stop 停止动画和 .update 更新要显示的文字。顺带说一下 .stop 也很简单，只是清除当前这一行的字符再清理掉之前用来循环的这个 interval 就行了。

另一个更为人性化的模块是 Ora，它提供了简单的「状态」管理，你可以在某个操作之后设置 spinner 的状态（成功或是失败），这样有更好的显示效果：